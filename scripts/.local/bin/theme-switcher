#!/bin/bash

# Configuration
THEMES_DIR="$HOME/dotfiles/themes"
CURRENT_LINK="$HOME/.config/themes/current"
WALLPAPER_STATE="$HOME/.cache/current-wallpaper"
YAZI_CONFIG_DIR="$HOME/.config/yazi"

# Source modules
MODULE_DIR="$HOME/dotfiles/others/theme-modules"

source "$MODULE_DIR/wallpaper.sh"
source "$MODULE_DIR/yazi.sh"
source "$MODULE_DIR/apps.sh"
source "$MODULE_DIR/ui.sh"

link_yazi_theme() {
    local theme_name="$1"
    local yazi_theme_source="${THEMES_DIR}/${theme_name}/yazi.toml"
    local yazi_theme_link="${YAZI_CONFIG_DIR}/theme.toml"
    
    # Check if yazi.toml exists in theme
    if [ ! -f "${yazi_theme_source}" ]; then
        echo "Warning: yazi.toml not found in theme '${theme_name}'"
        return 1
    fi
    
    # Create config directory if it doesn't exist
    mkdir -p "${YAZI_CONFIG_DIR}"
    
    # Remove old symlink if it exists
    if [ -L "${yazi_theme_link}" ] || [ -e "${yazi_theme_link}" ]; then
        rm -f "${yazi_theme_link}"
    fi
    
    # Create new symlink using absolute path
    ln -sf "${yazi_theme_source}" "${yazi_theme_link}"
    
    echo "Linked Yazi theme: ${theme_name}"
}
# Get list of available themes
themes=$(ls -1 "$THEMES_DIR")

# Show rofi menu and get selection
selected=$(echo "$themes" | rofi -dmenu -i -p "Select Theme" -no-custom)

# Exit if nothing selected
if [ -z "$selected" ]; then
    exit 0
fi

# Remove old symlink if it exists
rm -f "$CURRENT_LINK"

# Create new symlink
ln -s "$THEMES_DIR/$selected" "$CURRENT_LINK"

link_yazi_theme "$selected"

# Apply all themes
apply_all_themes "$CURRENT_LINK"

# Restart yazi
yazi_restart

# Set default wallpaper
set_default_wallpaper "$CURRENT_LINK"

# Restart UI components
restart_ui

# Notify user
notify-send "Theme Changed" "Applied $selected theme"
